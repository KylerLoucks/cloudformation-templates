AWSTemplateFormatVersion: 2010-09-09
Description: Creates a CodePipeline that deploys to an S3 bucket.

Parameters:

  # *** This value must always be passed in when creating / updating stack
  # "NoEcho" is set to true, for security, so token won't be visible when examining the resulting stack
  pGitHubOauthToken:
    Type: String
    Description: Token needs repo and webhook access. https://docs.aws.amazon.com/codepipeline/latest/userguide/GitHub-create-personal-token-CLI.html
    NoEcho: true

Resources:
  codePipeline: 
    Type: AWS::CodePipeline::Pipeline 
    Properties: 
      RoleArn:
        Ref: CodePipelineServiceRole 
      Stages: 
        - Name: Source 
          Actions: 
            - Name: SourceAction
              ActionTypeId: 
                # Type of Action (e.g. Source, Build, Invoke, Deploy) https://docs.aws.amazon.com/codepipeline/latest/userguide/integrations-action-type.html
                Category: Source
                Owner: AWS 

                # Variables to be referenced in other Actions. Ex: #{SourceVariables.commitId} https://docs.aws.amazon.com/codepipeline/latest/userguide/reference-variables.html
                Namespace: SourceVariables

                # depends on 'Owner' (e.g. ThirdParty) https://docs.aws.amazon.com/codepipeline/latest/userguide/reference-pipeline-structure.html#reference-action-artifacts
                Provider: CodeStarSourceConnection
                Version: 1

              # CodeStar Source Connection: https://docs.aws.amazon.com/codepipeline/latest/userguide/action-reference-CodestarConnectionSource.html
              Configuration:
                # arn:aws:codestar-connections:us-east-1:account-id:connection/e341bf9a-e456-497e-bde3-6a695322853a
                # Import value from codestar-connection.yml template
                ConnectionArn: !ImportValue CODESTARCONNECTION
                
                # Owner and Name of the repository
                FullRepositoryId: some-user/my-repo
                BranchName: master
                OutputArtifactFormat: CODE_ZIP
              OutputArtifacts: 
                - Name: SourceOutput 
            
            # Manual Approval URL with output variables: https://docs.aws.amazon.com/codepipeline/latest/userguide/actions-variables.html#actions-variables-examples-approvals
            
            - Name: Deploy
              Actions:
                - Name: S3
                  ActionTypeId:
                    Category: Deploy
                    Owner: AWS
                    Provider: S3
                    Version: 1
                  Configuration:
                    ClusterName: !Ref pDeploymentBucketName
                    ServiceName: !Ref pEcsServiceName
                    FileName: !Ref pImageDefinitionFile
                  InputArtifacts:
                    - Name: SourceOutput
      ArtifactStore: 
        Type: S3 
        Location: !Ref ArtifactStoreS3Location 
        EncryptionKey:
          Id: arn:aws:kms:useast-1:ACCOUNT-ID:key/KEY-ID
          Type: KMS
      DisableInboundStageTransitions: 
        - StageName: Release 
          Reason: "Disabling the transition until integration tests are completed"
      Tags:
        - Key: Project
          Value: ProjectA

  s3ArtifactBucketCodePipeline:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub codepipeline-artifacts-${AWS::Region}-${AWS::AccountId}
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      Tags:
        - Key: environment
          Value: !Ref pEnvironmentTag